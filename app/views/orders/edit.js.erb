

$('#content').replaceWith( '<%= j render("form") %>');
pageSetUp();


$("orderdetail")
<% if flash.any? %>
  $('#content').before('<%= j render("shared/messages") %>');
<% end %>

setTimeout(function() {
  $('.flash-messages').remove();
}, 10000);


$('form').on('click', '.remove_fields', function(event) {
  $(this).prev('input[type=hidden]').val('1');
  $(this).closest('tr').hide("slow");
  event.preventDefault();
});

$('form').on('click', '.remove_item_fields', function(event) {
  $(this).prev('input[type=hidden]').val('1');
  $(this).closest('fieldset').hide("slow");
  event.preventDefault();
});

$('form').on('click', '.add_fields', function(event) {
  time = new Date().getTime();
  regexp = new RegExp($(this).data('id'), 'g');
  $(this).before($(this).data('fields').replace(regexp, time));
  event.preventDefault();
  auto_complete_items();
});

var auto_complete_items = function() {
  $(".item_name" ).autocomplete({
    source: "/ajax/item_names"
  });
}

$('.js-shipDelivery').click(function() {
  var shipDelivery = $(this).data("location-description");
  $('#order_ship_delivery').val(shipDelivery);
});

$('.js-pickupDelivery').click(function() {
  var pickupDelivery = $(this).data("location-description");
  $('#order_ship_pick_up').val(pickupDelivery);
});

auto_complete_items();




var filterBySelect = function(update_select, search) {
  // var regex = new RegExp(search, 'gi');
  $(update_select).empty();

  $("#hidden_select").find('option').each(function(){
    var new_description = $(this).text();
    var new_value = $(this).val();

    console.log("search: " + search + "new value: " + new_value);
    console.log($(this).text());
    if(new_description.match(search) !== null) {
      $(update_select).append($("<option value=" + new_value + ">" + new_description + "</option>"));
    }     
  });
}

function itemData() {
  var optionElements = []

  $("#hidden_select").find('option').each(function(){
    var description = $(this).text();
    var value = $(this).val();
    optionElements.push($("<option value=" + value + ">" + description + "</option>"));
  });
  return optionElements;
};

$('form').on("change", ".variety", function(){
  var grade = $(this).closest(".item-select-helpers").find(".grade").find(":selected").html();
  var size = $(this).closest(".item-select-helpers").find(".size").find(":selected").html();
  var variety = $(this).closest(".item-select-helpers").find(".variety").find(":selected").html();
  var update_select = $(this).parent().parent().next("tr").find(".item-select").first();
  var search = getSearchArgs(grade, size, variety);
  filterBySelect(update_select, search);
});

$('form').on("change", ".grade", function(){
  var grade = $(this).closest(".item-select-helpers").find(".grade").find(":selected").html();
  var size = $(this).closest(".item-select-helpers").find(".size").find(":selected").html();
  var variety = $(this).closest(".item-select-helpers").find(".variety").find(":selected").html();
  var update_select = $(this).parent().parent().next("tr").find(".item-select").first();
  var search = getSearchArgs(grade, size, variety);
  filterBySelect(update_select, search);
});

$('form').on("change", ".size", function(){
  var grade = $(this).closest(".item-select-helpers").find(".grade").find(":selected").html();
  var size = $(this).closest(".item-select-helpers").find(".size").find(":selected").html();
  var variety = $(this).closest(".item-select-helpers").find(".variety").find(":selected").html();
  var update_select = $(this).parent().parent().next("tr").find(".item-select").first();
  var search = getSearchArgs(grade, size, variety);
  filterBySelect(update_select, search);
});


var getSearchArgs = function(string) {

  var search = [];

  if(string !== ""){
    grade = "(^|\\W)(" + escapeRegExp(string) + ")(?!\\w)";
    search.push(grade);
  }

  if(variety !== ""){
    variety = "(^|\\W)(" + escapeRegExp(variety) + ")(?!\\w)";
    search.push(variety);
  }

  if(size !== ""){
    size = "(^|\\W)" + escapeRegExp(size) + "(?!\\w)";
    search.push(size);
  }

  // searchArg = (search.length==1)?search:search.join("");
  searchArg = search.join("");

  return searchArg;
};

function escapeRegExp(str) {
  var r = str.replace(/[\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|\-]/g, "\\$&");
  return r;
}
